import { Telegraf } from "telegraf";
import axios from "axios";
import fs from "fs";

// Load ENV
const BOT_TOKEN = process.env.BOT_TOKEN;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const FLW_SECRET_KEY = process.env.FLW_SECRET_KEY;
const PREMIUM_PRICE_NGN = process.env.PREMIUM_PRICE_NGN || 1000;
const DB_FILE = process.env.DB_FILE || "./data/db.json";

const bot = new Telegraf(BOT_TOKEN);

// Load DB
let db = { users: {} };
if (fs.existsSync(DB_FILE)) {
  db = JSON.parse(fs.readFileSync(DB_FILE));
}

// Save DB
function saveDB() {
  fs.writeFileSync(DB_FILE, JSON.stringify(db, null, 2));
}

// Create payment
async function createPayment(ref, amount) {
  const res = await axios.post(
    "https://api.flutterwave.com/v3/payments",
    {
      tx_ref: ref,
      amount: amount,
      currency: "NGN",
      redirect_url: "https://google.com", // ba lallai ba
      customer: {
        email: `${ref}@mail.com`,
      },
      customizations: {
        title: "Premium Access",
        description: "Unlock unlimited AI access",
      },
    },
    {
      headers: {
        Authorization: `Bearer ${FLW_SECRET_KEY}`,
      },
    }
  );

  return res.data.data.link; // payment link
}

// Verify payment
async function verifyPayment(txRef) {
  const res = await axios.get(
    `https://api.flutterwave.com/v3/transactions?tx_ref=${txRef}`,
    {
      headers: {
        Authorization: `Bearer ${FLW_SECRET_KEY}`,
      },
    }
  );

  const data = res.data.data;

  if (!data || data.length === 0) return false;
  if (data[0].status !== "successful") return false;

  return true;
}

// START
bot.start((ctx) => {
  ctx.reply("Barka da zuwa! Rubuta /premium domin biya.");
});

// PREMIUM
bot.command("premium", async (ctx) => {
  const userId = ctx.from.id;
  const ref = `tx_${userId}_${Date.now()}`;

  const paymentLink = await createPayment(ref, PREMIUM_PRICE_NGN);

  ctx.reply(
    `**Premium Price:** â‚¦${PREMIUM_PRICE_NGN}\n\nBi wannan link ka biyağŸ‘‡\n${paymentLink}`,
    { parse_mode: "Markdown" }
  );
});

// VERIFY
bot.command("verify", async (ctx) => {
  const parts = ctx.message.text.split(" ");
  if (parts.length < 2) {
    return ctx.reply("Misali: /verify tx_12345");
  }

  const txRef = parts[1];
  ctx.reply("Ana duba biyan ka...");

  const ok = await verifyPayment(txRef);

  if (!ok) {
    return ctx.reply("âŒ Biyan ba a samu successful ba. Ka sake dubawa.");
  }

  db.users[ctx.from.id] = { premium: true };
  saveDB();

  ctx.reply("ğŸ‰ *An kunna maka Premium!*", { parse_mode: "Markdown" });
});

// Run bot
bot.launch();
console.log("Bot is running...");
